{% extends "base.html" %}

{% block title %}New Purchase - StockFlow{% endblock %}

{% block content %}
<h1 class="mb-4">Record New Purchase</h1>

<form id="purchaseForm">
    <div class="row mb-4">
        <div class="col-md-6">
            <label class="form-label fw-bold">Supplier</label>
            <div class="input-group">
                <select name="supplier_id" id="supplierSelect" class="form-select" required>
                    <option value="">Select supplier</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier._id }}">{{ supplier.name }} ({{ supplier.contact_person or 'No contact' }})</option>
                    {% endfor %}
                </select>
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addSupplierModal">
                    <i class="fas fa-plus"></i> New
                </button>
            </div>
        </div>
    </div>

    <h5 class="mb-3">Purchase Items</h5>
    <div id="itemsContainer">
        <div class="row g-3 mb-3 item-row">
            <div class="col-md-5">
                <select name="product_id" class="form-select product-select" required>
                    <option value="">Select product</option>
                    {% for product in products %}
                    <option value="{{ product._id }}" data-price="{{ product.purchase_price }}">
                        {{ product.name }} (Stock: {{ product.current_quantity }} | Price: KSh {{ "%.2f"|format(product.purchase_price) }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <input type="number" name="quantity" class="form-control" placeholder="Quantity" min="1" required>
            </div>
            <div class="col-md-3">
                <input type="number" step="0.01" name="cost_price" class="form-control cost-price" placeholder="Cost Price (KSh)" required>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-danger remove-item"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    </div>

    <button type="button" class="btn btn-secondary mb-3" id="addItem">
        <i class="fas fa-plus"></i> Add Another Item
    </button>

    <div class="text-end mb-5">
        <h4>Total Cost: <span id="totalCost">KSh 0.00</span></h4>
    </div>

    <div class="text-end">
        <a href="/purchases" class="btn btn-secondary me-2">Cancel</a>
        <button type="submit" class="btn btn-success btn-lg">Record Purchase</button>
    </div>
</form>


<div class="modal fade" id="addSupplierModal">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <form id="supplierForm">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-truck me-2"></i>Add New Supplier</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Supplier Name <span class="text-danger">*</span></label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Contact Person</label>
                        <input type="text" name="contact_person" class="form-control">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Phone</label>
                            <input type="tel" name="phone" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Email</label>
                            <input type="email" name="email" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Address</label>
                        <textarea name="address" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Supplier</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>

document.getElementById('addItem').addEventListener('click', function() {
    const container = document.getElementById('itemsContainer');
    const row = container.querySelector('.item-row').cloneNode(true);
    row.querySelectorAll('input, select').forEach(el => el.value = '');
    container.appendChild(row);
    calculateTotal();
});

document.getElementById('itemsContainer').addEventListener('click', function(e) {
    if (e.target.closest('.remove-item')) {
        if (document.querySelectorAll('.item-row').length > 1) {
            e.target.closest('.item-row').remove();
            calculateTotal();
        }
    }
});


document.getElementById('itemsContainer').addEventListener('input', calculateTotal);

function calculateTotal() {
    let total = 0;
    document.querySelectorAll('.item-row').forEach(row => {
        const qty = parseFloat(row.querySelector('[name="quantity"]').value) || 0;
        const price = parseFloat(row.querySelector('[name="cost_price"]').value) || 0;
        total += qty * price;
    });
    document.getElementById('totalCost').textContent = 'KSh ' + total.toFixed(2);
}


document.getElementById('purchaseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        supplier_id: document.querySelector('[name="supplier_id"]').value,
        items: []
    };

    document.querySelectorAll('.item-row').forEach(row => {
        formData.items.push({
            product_id: row.querySelector('[name="product_id"]').value,
            quantity: parseInt(row.querySelector('[name="quantity"]').value),
            cost_price: parseFloat(row.querySelector('[name="cost_price"]').value)
        });
    });

    fetch('/purchases/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.redirect) {
            
            window.location.href = data.redirect;
        } else {
            alert(data.message || 'Purchase recorded!');
            window.location.href = '/purchases';
        }
    })
    .catch(err => {
        console.error(err);
        alert('Error recording purchase. Check console.');
    });
});


document.getElementById('supplierForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);

    fetch('/suppliers/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(result.message);
            
            const select = document.getElementById('supplierSelect');
            const option = document.createElement('option');
            option.value = result.supplier_id;
            option.textContent = data.name + (data.contact_person ? ' (' + data.contact_person + ')' : '');
            option.selected = true;
            select.appendChild(option);
            
            bootstrap.Modal.getInstance(document.getElementById('addSupplierModal')).hide();
            this.reset();
        } else {
            alert(result.message || 'Error adding supplier');
        }
    })
    .catch(err => alert('Error adding supplier'));
});
</script>
{% endblock %}